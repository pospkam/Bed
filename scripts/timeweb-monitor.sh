#!/bin/bash

###############################################################################
# KAMHUB - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º—ã
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∏ –∑–¥–æ—Ä–æ–≤—å—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
###############################################################################

# –¶–≤–µ—Ç–∞
GREEN='\033[0;32m'
BLUE='\033[0;34m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo ""
echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo "‚ïë              KAMHUB - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º—ã                   ‚ïë"
echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
echo ""

# –°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
echo "üìä –°–ò–°–¢–ï–ú–ê:"
echo "   ‚Ä¢ Uptime: $(uptime -p)"
echo "   ‚Ä¢ Load Average: $(uptime | awk -F'load average:' '{print $2}')"
echo "   ‚Ä¢ –ü–∞–º—è—Ç—å: $(free -h | awk 'NR==2{printf "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: %s / %s (%.2f%%)", $3,$2,$3*100/$2 }')"
echo "   ‚Ä¢ –î–∏—Å–∫: $(df -h / | awk 'NR==2{printf "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: %s / %s (%s)", $3,$2,$5}')"
echo ""

# PM2 —Å—Ç–∞—Ç—É—Å
echo "üöÄ PM2 –ü–†–û–¶–ï–°–°–´:"
pm2 status
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
echo "üîç –ü–†–û–í–ï–†–ö–ê –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø:"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–∞ 3000
if netstat -tuln | grep -q ':3000 '; then
    echo -e "   ‚Ä¢ –ü–æ—Ä—Ç 3000: ${GREEN}‚úì –°–ª—É—à–∞–µ—Ç—Å—è${NC}"
else
    echo -e "   ‚Ä¢ –ü–æ—Ä—Ç 3000: ${RED}‚úó –ù–µ –¥–æ—Å—Ç—É–ø–µ–Ω${NC}"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Nginx
if systemctl is-active --quiet nginx; then
    echo -e "   ‚Ä¢ Nginx: ${GREEN}‚úì –†–∞–±–æ—Ç–∞–µ—Ç${NC}"
else
    echo -e "   ‚Ä¢ Nginx: ${RED}‚úó –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω${NC}"
fi

# HTTP —Ç–µ—Å—Ç
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost 2>/dev/null || echo "000")
if [ "$HTTP_CODE" = "200" ]; then
    echo -e "   ‚Ä¢ HTTP –æ—Ç–≤–µ—Ç: ${GREEN}‚úì 200 OK${NC}"
elif [ "$HTTP_CODE" = "000" ]; then
    echo -e "   ‚Ä¢ HTTP –æ—Ç–≤–µ—Ç: ${RED}‚úó –ù–µ –æ—Ç–≤–µ—á–∞–µ—Ç${NC}"
else
    echo -e "   ‚Ä¢ HTTP –æ—Ç–≤–µ—Ç: ${YELLOW}‚ö† $HTTP_CODE${NC}"
fi

echo ""

# –õ–æ–≥–∏
echo "üìù –ü–û–°–õ–ï–î–ù–ò–ï –õ–û–ì–ò PM2:"
pm2 logs kamhub --lines 10 --nostream
echo ""

# Nginx –æ—à–∏–±–∫–∏
if [ -f /var/log/nginx/kamhub-error.log ]; then
    ERROR_COUNT=$(wc -l < /var/log/nginx/kamhub-error.log)
    if [ "$ERROR_COUNT" -gt 0 ]; then
        echo -e "‚ö†Ô∏è  Nginx: ${YELLOW}$ERROR_COUNT${NC} –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö"
        echo "   –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏:"
        tail -5 /var/log/nginx/kamhub-error.log | sed 's/^/   /'
    else
        echo -e "‚úÖ Nginx: ${GREEN}–ù–µ—Ç –æ—à–∏–±–æ–∫${NC}"
    fi
    echo ""
fi

# –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
echo "üîß –ë–´–°–¢–†–´–ï –ö–û–ú–ê–ù–î–´:"
echo "   ‚Ä¢ pm2 restart kamhub    - –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
echo "   ‚Ä¢ pm2 logs kamhub       - –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤"
echo "   ‚Ä¢ pm2 monit             - –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥"
echo "   ‚Ä¢ systemctl reload nginx - –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ Nginx"
echo "   ‚Ä¢ /root/update-kamhub.sh - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞"
echo ""
